---
title: "ElanExtraction"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Working directory

```{r}
# Set the directory to where the R code is located 

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

```

## Packages needed 

```{r}
# install.packages("tidyverse")
# install.packages("xml2")

library(tidyverse)
library(xml2)

```

```{r}
# Load the ELAN XML file
elan_file <- read_xml("files/280117_10_Hamid_Clandividing.eaf")

#' Extract Annotations from ELAN XML File
#'
#' This function parses an ELAN XML file to extract annotations and organize them into a tibble (DataFrame).
#' Each row in the tibble corresponds to an annotation, including both ALIGNABLE_ANNOTATION and REF_ANNOTATION types.
#' The function extracts various attributes for each annotation, such as linguistic references, annotation IDs, and time slots.
#' It is designed to handle variations in annotation ID formats by safely converting string IDs to numeric where applicable.
#' If an annotation ID does not follow the expected pattern (e.g., "ann" followed by digits), it avoids conversion to prevent coercion warnings.
#'
#' @param elan_xml An XML document object representing the ELAN file, loaded using xml2::read_xml().
#'
#' @return A tibble with each row representing an annotation from the ELAN file and columns for:
#'         LANG_REF, LINGUISTIC_TYPE_REF, PARENT_REF, ANNOTATION_ID, ANNOTATION_REF, ANNOTATION_VALUE,
#'         PREVIOUS_ANNOTATION, TIME_SLOT_REF1, TIME_SLOT_REF2, anno_ref_numeric, and TIER_ID.
#'
#' @examples
#' elan_file <- xml2::read_xml("path/to/elan_file.eaf")
#' annotations_df <- extract_annotations(elan_file)
#' print(annotations_df)
#'
#' @note This function assumes the ELAN XML structure is consistent with ELAN standards, but it is robust
#'       against variations in annotation ID formats. Non-numeric IDs or IDs not following the "ann\d+" pattern
#'       result in NA_real_ for the anno_ref_numeric column to ensure data integrity.
extract_annotations <- function(elan_xml) {
  annotations <- xml_find_all(elan_xml, "//TIER/*/*") # Matches both ALIGNABLE_ANNOTATION and REF_ANNOTATION
  
  data <- lapply(annotations, function(node) {
    tier_node <- xml_parent(xml_parent(node))
    
    data <- tibble(
      LANG_REF = xml_attr(tier_node, "DEFAULT_LOCALE"),
      LINGUISTIC_TYPE_REF = xml_attr(tier_node, "LINGUISTIC_TYPE_REF"),
      PARENT_REF = xml_attr(tier_node, "PARENT_REF"),
      TIER_ID = xml_attr(tier_node, "TIER_ID"),
      ANNOTATION_ID = xml_attr(node, "ANNOTATION_ID"),
      ANNOTATION_REF = xml_attr(node, "ANNOTATION_REF"),
      PREVIOUS_ANNOTATION = xml_attr(node, "PREVIOUS_ANNOTATION"),
      TIME_SLOT_REF1 = xml_attr(node, "TIME_SLOT_REF1"),
      TIME_SLOT_REF2 = xml_attr(node, "TIME_SLOT_REF2"),
      ANNOTATION_VALUE = xml_text(xml_find_first(node, ".//ANNOTATION_VALUE")),
      anno_ref_numeric = ifelse(grepl("^ann\\d+$", ANNOTATION_ID), 
                               as.numeric(gsub("ann", "", ANNOTATION_ID, fixed = TRUE)), 
                               NA_real_)
    )
    
    return(data)
  })
  
  do.call(rbind, data)
}

# Extract annotations into a DataFrame
annotations_df <- extract_annotations(elan_file)

# View the resulting DataFrame
print(annotations_df)

```

